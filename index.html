<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event Feedback & Certificate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üìù</text></svg>" type="image/svg+xml">
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        body::-webkit-scrollbar { width: 8px; }
        body::-webkit-scrollbar-thumb { background-color: #A9A9A9; border-radius: 4px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen antialiased">
<div id="root"></div>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script src="./supabase.min.js" id="supabaseScript" onload="window.supabaseLoaded = true;" onerror="console.error('‚ùå Supabase script failed to load')"></script>

<script type="text/babel">
    const { useState, useEffect, useCallback, Fragment } = React;
    const jsPDF = window.jspdf.jsPDF;

    // --- KILALI BRAND CONSTANTS ---
    const PRIMARY_RED = '#8B0000';
    const ACCENT_GOLD = '#FFD700';
    const TEXT_DARK = '#1f2937';
    const KILALI_TRIBE_WEBSITE = 'https://kilalitribe.com'; 
    const EVENT_TITLE = 'Kilali Tribe Conference 2025';
    const EVENT_THEME = 'Bold Moves How Women Win: Wealth, Power, and Creativity';
    const KILALI_LOGO_URL = 'https://pddykkkndrygfrwonjak.supabase.co/storage/v1/object/public/Logo/Kalili%20logo.jpg';
    const SIGNATURE_IMAGE_URL = 'https://pddykkkndrygfrwonjak.supabase.co/storage/v1/object/public/Logo/Signature%20-%20Chairperson%20Kilali.png';
    const ADMIN_EMAILS = ['admin@kilalitribe.com', 'siriwebdv@gmail.com']; 
    
    const loadImage = async (src) => {
        if (!src) return null;
        try {
            const response = await fetch(src); if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const blob = await response.blob();
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => { const img = new Image(); img.onload = () => resolve({ dataUrl: reader.result, width: img.naturalWidth, height: img.naturalHeight }); img.onerror = (e) => reject(new Error(`Image load error: ${e.message}`)); img.src = reader.result; };
                reader.onerror = reject; reader.readAsDataURL(blob);
            });
        } catch (error) { console.warn(`‚ö†Ô∏è Failed to load image from ${src}. Error:`, error.message); return null; }
    };
    
    const StatusMessage = ({ msg, type = 'info' }) => {
        const colors = { success: 'text-green-600', error: 'text-red-600', info: 'text-blue-600' };
        return <p className={`text-center font-medium text-sm my-4 ${colors[type]}`}>{msg}</p>;
    };
    
    const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fillRule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clipRule="evenodd" /></svg>;
    const DeleteIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" /></svg>;
    const CheckCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>;
    const XCircleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4 mr-1.5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>;

    const AdminDashboard = ({ supabase }) => {
        const [submissions, setSubmissions] = useState([]); const [isLoading, setIsLoading] = useState(true); const [message, setMessage] = useState({ text: '', type: 'info' }); const [editingSubmission, setEditingSubmission] = useState(null); const [emailToAdd, setEmailToAdd] = useState(''); const [isAdding, setIsAdding] = useState(false); const [showAddForm, setShowAddForm] = useState(false); const [currentPage, setCurrentPage] = useState(1); const [itemsPerPage, setItemsPerPage] = useState(50); const [searchTerm, setSearchTerm] = useState('');
        const ROWS_PER_PAGE_OPTIONS = [10, 25, 50, 100];

        const fetchSubmissions = useCallback(async () => {
            setIsLoading(true);
            try {
                const { data, error } = await supabase.from('feedback_submissions').select('*').order('created_at', { ascending: false }); if (error) throw error;
                const sortedData = data.sort((a, b) => (a.certificate_downloaded_at && !b.certificate_downloaded_at) ? -1 : (!a.certificate_downloaded_at && b.certificate_downloaded_at) ? 1 : 0);
                setSubmissions(sortedData);
            } catch (error) { setMessage({ text: `‚ùå Error fetching data: ${error.message}`, type: 'error' });
            } finally { setIsLoading(false); }
        }, [supabase]);

        useEffect(() => { fetchSubmissions(); }, [fetchSubmissions]);

        const handleAddParticipant = async (e) => {
            e.preventDefault(); const email = emailToAdd.trim().toLowerCase(); if (!email) return;
            if (submissions.some(sub => sub.registered_email.toLowerCase() === email)) { setMessage({ text: '‚ùå Email already exists.', type: 'error' }); return; }
            setIsAdding(true); setMessage({ text: '‚è≥ Adding participant...', type: 'info' });
            try {
                const { error } = await supabase.from('feedback_submissions').insert({ registered_email: email }); if (error) throw error;
                setMessage({ text: `‚úÖ Participant ${email} added!`, type: 'success' }); setEmailToAdd(''); setShowAddForm(false); fetchSubmissions();
            } catch (error) { setMessage({ text: `‚ùå Error adding email: ${error.message}`, type: 'error' });
            } finally { setIsAdding(false); }
        };
        
        const handleDelete = async (id) => {
            if (window.confirm('Are you sure you want to delete this submission?')) {
                try { const { error } = await supabase.from('feedback_submissions').delete().eq('id', id); if (error) throw error; setMessage({ text: '‚úÖ Submission deleted.', type: 'success' }); fetchSubmissions();
                } catch (error) { setMessage({ text: `‚ùå Error deleting: ${error.message}`, type: 'error' }); }
            }
        };

        const handleUpdate = async (id, updatedData) => {
            try { const { error } = await supabase.from('feedback_submissions').update(updatedData).eq('id', id); if (error) throw error; setMessage({ text: '‚úÖ Submission updated.', type: 'success' }); setEditingSubmission(null); fetchSubmissions(); return true;
            } catch (error) { setMessage({ text: `‚ùå Error updating: ${error.message}`, type: 'error' }); return false; }
        };

        const filteredSubmissions = submissions.filter(sub => (sub.name && sub.name.toLowerCase().includes(searchTerm.toLowerCase())) || (sub.registered_email && sub.registered_email.toLowerCase().includes(searchTerm.toLowerCase())));
        const totalPages = Math.ceil(filteredSubmissions.length / itemsPerPage);
        const currentSubmissions = filteredSubmissions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);
        const handleItemsPerPageChange = (e) => { setItemsPerPage(Number(e.target.value)); setCurrentPage(1); };
        const handleSearchChange = (e) => { setSearchTerm(e.target.value); setCurrentPage(1); };

        return (
            <div className="bg-slate-100 min-h-screen">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                    {message.text && <div className="mb-4"><StatusMessage msg={message.text} type={message.type} /></div>}
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="p-6 border-b border-slate-200"><div className="flex flex-col sm:flex-row justify-between sm:items-center gap-4"><div><h2 className="text-2xl font-bold text-slate-800">Admin Dashboard</h2><p className="text-sm text-slate-500 mt-1">Manage participants and view feedback.</p></div><button onClick={() => setShowAddForm(!showAddForm)} style={{ backgroundColor: showAddForm ? '#6b7280' : PRIMARY_RED }} className="px-5 py-2.5 rounded-lg font-semibold text-white transition-all duration-300 shadow-md hover:opacity-90 flex-shrink-0">{showAddForm ? 'Cancel' : 'Add Participant'}</button></div>{showAddForm && (<form onSubmit={handleAddParticipant} className="flex gap-3 mt-6 border-t border-slate-200 pt-6"><input type="email" value={emailToAdd} onChange={(e) => setEmailToAdd(e.target.value)} placeholder="New participant's email address..." required className="flex-grow p-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-red-500/50 focus:outline-none transition"/><button type="submit" disabled={isAdding} style={{ backgroundColor: PRIMARY_RED }} className={`px-6 py-3 rounded-lg font-bold text-white transition-all shadow-sm ${isAdding ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-80'}`}>{isAdding ? 'Adding...' : 'Save'}</button></form>)}</div>
                        <div className="p-6"><input type="text" placeholder="Search by name or email..." value={searchTerm} onChange={handleSearchChange} className="w-full p-3 pl-10 border border-slate-300 rounded-lg focus:ring-2 focus:ring-red-500/50 focus:outline-none transition bg-slate-50"/></div>
                        {isLoading ? <p className="text-center p-10 text-slate-500">Loading submissions...</p> : (<div className="overflow-x-auto"><table className="min-w-full divide-y divide-slate-200"><thead className="bg-slate-50"><tr><th className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Name</th><th className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Email</th><th className="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">Feedback</th><th className="px-6 py-4 text-center text-xs font-semibold text-slate-500 uppercase tracking-wider">Downloaded</th><th className="px-6 py-4 text-right text-xs font-semibold text-slate-500 uppercase tracking-wider">Actions</th></tr></thead><tbody className="bg-white divide-y divide-slate-200">{currentSubmissions.map(sub => (<tr key={sub.id} className="hover:bg-slate-50 transition-colors duration-150"><td className="px-6 py-4 text-sm font-medium text-slate-900 align-top">{sub.name === 'Not NULL' || !sub.name ? '' : sub.name}</td><td className="px-6 py-4 text-sm text-slate-500 align-top">{sub.registered_email}</td><td className="px-6 py-4 text-sm text-slate-600 align-top whitespace-normal break-words max-w-xs">{sub.feedback === 'Not NULL' || !sub.feedback ? '' : sub.feedback}</td><td className="px-6 py-4 text-sm text-center align-top">{sub.certificate_downloaded_at ? <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><CheckCircleIcon /> Yes</span> : <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800"><XCircleIcon /> No</span>}</td><td className="px-6 py-4 text-right text-sm font-medium align-top"><div className="flex justify-end items-center space-x-4"><button onClick={() => setEditingSubmission(sub)} className="text-blue-500 hover:text-blue-700 transition" title="Edit"><EditIcon /></button><button onClick={() => handleDelete(sub.id)} className="text-red-500 hover:text-red-700 transition" title="Delete"><DeleteIcon /></button></div></td></tr>))}</tbody></table></div>)}
                        <div className="p-4 flex items-center justify-between border-t border-slate-200 bg-slate-50/50"><div className="flex items-center space-x-2"><span className="text-sm text-slate-600">Rows:</span><select value={itemsPerPage} onChange={handleItemsPerPageChange} className="p-1 border border-slate-300 rounded-md text-sm bg-white focus:ring-1 focus:ring-red-500/50 focus:outline-none">{ROWS_PER_PAGE_OPTIONS.map(option => <option key={option} value={option}>{option}</option>)}</select></div><div className="flex items-center space-x-4"><span className="text-sm text-slate-600">Page {currentPage} of {totalPages || 1}</span><button onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))} disabled={currentPage === 1} className="px-3 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition">Prev</button><button onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))} disabled={currentPage === totalPages || filteredSubmissions.length === 0} className="px-3 py-1.5 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded-md hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed transition">Next</button></div></div>
                    </div>{editingSubmission && <EditModal submission={editingSubmission} onUpdate={handleUpdate} onClose={() => setEditingSubmission(null)} />}
                </div>
            </div>
        );
    };

    const EditModal = ({ submission, onUpdate, onClose }) => {
        const [formData, setFormData] = useState({ name: submission.name === 'Not NULL' ? '' : (submission.name || ''), registered_email: submission.registered_email || '' });
        const [isUpdating, setIsUpdating] = useState(false);
        const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });
        const handleSubmit = async (e) => { e.preventDefault(); setIsUpdating(true); const success = await onUpdate(submission.id, formData); if (!success) setIsUpdating(false); };
        return (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl shadow-2xl p-8 max-w-lg w-full"><h3 className="text-2xl font-bold text-gray-800 mb-6">Edit Participant</h3><form onSubmit={handleSubmit} className="space-y-4"><div><label className="block text-sm font-medium text-gray-700">Full Name</label><input type="text" name="name" value={formData.name} onChange={handleChange} className="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition" /></div><div><label className="block text-sm font-medium text-gray-700">Registered Email</label><input type="email" name="registered_email" value={formData.registered_email} onChange={handleChange} required className="mt-1 w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition" /></div><div className="flex justify-end space-x-3 pt-4"><button type="button" onClick={onClose} className="px-4 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300 transition-colors">Cancel</button><button type="submit" disabled={isUpdating} style={{ backgroundColor: PRIMARY_RED }} className={`px-4 py-2 rounded-lg font-bold text-white transition-all duration-300 shadow-md ${isUpdating ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-80'}`}>{isUpdating ? 'Saving...' : 'Save Changes'}</button></div></form></div></div>);
    };

    const LoginModal = ({ show, onClose, supabase }) => {
        const [email, setEmail] = useState(''); const [message, setMessage] = useState(''); const [isLoading, setIsLoading] = useState(false);
        const handleLogin = async (e) => { 
            e.preventDefault(); setIsLoading(true); setMessage('‚è≥ Sending magic link...');
            const redirectURL = window.location.hostname === 'localhost' ? window.location.origin : 'https://cert.kilalitribe.com';
            try { 
                const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: redirectURL }}); 
                if (error) throw error; 
                setMessage('‚úÖ Success! Check your inbox.'); setEmail(''); 
            } catch (error) { setMessage(`‚ùå Login failed: ${error.message}`); 
            } finally { setIsLoading(false); }
        };
        if (!show) return null;
        return (<div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"><div className="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full"><h3 className="text-2xl font-bold text-gray-800 mb-4">Administrator Login</h3>{message && <StatusMessage msg={message} type={message.startsWith('‚ùå') ? 'error' : 'info'} />}<form onSubmit={handleLogin} className="space-y-4"><input type="email" value={email} onChange={(e) => setEmail(e.target.value)} placeholder="Enter Admin Email" required className="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition"/><button type="submit" disabled={isLoading} style={{ backgroundColor: PRIMARY_RED }} className={`w-full p-3 rounded-lg font-bold text-white transition-all duration-300 shadow-md ${isLoading ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-80'}`}>{isLoading ? 'Sending...' : 'Send Magic Link'}</button></form><button onClick={onClose} className="mt-4 w-full text-sm text-center text-gray-500 hover:text-red-500">Close</button></div></div>);
    };

    const Header = ({ user, isAdmin, onLoginClick, onLogoutClick }) => (<header className="w-full bg-white border-b border-slate-200 sticky top-0 z-40"><div className="max-w-7xl mx-auto flex justify-between items-center px-4 sm:px-6 lg:px-8 py-3"><a href={KILALI_TRIBE_WEBSITE} target="_blank" rel="noopener noreferrer"><img src={KILALI_LOGO_URL} alt="Kilali Tribe Logo" className="h-10 w-auto"/></a><div className="flex items-center space-x-4">{user ? (<><span className={`hidden sm:inline text-sm font-medium ${isAdmin ? 'text-red-600' : 'text-gray-600'}`}>{user.email} {isAdmin && '(Admin)'}</span><button onClick={onLogoutClick} className="px-4 py-2 bg-slate-100 text-slate-800 text-sm font-semibold rounded-lg hover:bg-slate-200 transition-colors">Logout</button></>) : (<button onClick={onLoginClick} className="p-2 rounded-full text-slate-500 hover:bg-slate-100 hover:text-red-600 transition-colors" title="Admin Login"><svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg></button>)}</div></div></header>);

    window.App = function() { 
        const supabase = window.supabase;
        const [user, setUser] = useState(null); const [isAdmin, setIsAdmin] = useState(false); const [showLoginModal, setShowLoginModal] = useState(false); const [isAuthReady, setIsAuthReady] = useState(false);
        const [formData, setFormData] = useState({ name: '', registeredEmail: '', email: '', feedback: '' });
        const [message, setMessage] = useState(''); const [isSubmitting, setIsSubmitting] = useState(false); const [submitted, setSubmitted] = useState(false); const [isGenerating, setIsGenerating] = useState(false);
        const [participantRecords, setParticipantRecords] = useState([]);

        const fetchParticipantRecords = useCallback(async () => {
            if (!supabase) return;
            try { 
                const { data, error } = await supabase.from('feedback_submissions').select('*'); if (error) throw error; 
                setParticipantRecords(data || []);
            } catch (error) { console.error('Error fetching participant records:', error); setMessage(`‚ùå Critical Error: Could not load participant list. Check security rules.`); }
        }, [supabase]);

        useEffect(() => {
            if (!supabase) return;
            const { data: { subscription } } = supabase.auth.onAuthStateChange((_, session) => {
                const currentUser = session?.user || null;
                setUser(currentUser); setIsAdmin(currentUser && ADMIN_EMAILS.includes(currentUser.email.toLowerCase())); setIsAuthReady(true); if (currentUser) setShowLoginModal(false);
            });
            fetchParticipantRecords();
            return () => subscription?.unsubscribe();
        }, [supabase, fetchParticipantRecords]);

        const handleChange = (e) => setFormData({ ...formData, [e.target.name]: e.target.value });

        const handleSubmit = async (e) => {
            e.preventDefault(); setIsSubmitting(true); setMessage('');
            const submittedEmail = formData.registeredEmail.trim().toLowerCase();
            const record = participantRecords.find(p => p.registered_email.toLowerCase() === submittedEmail);
            
            if (!record) { setMessage('‚ùå Email not found in approved list.'); setIsSubmitting(false); return; }
            
            // --- FIX: Logic to handle re-submission and "Not NULL" ---
            if (record.name && record.name !== 'Not NULL') { 
                setMessage('‚úÖ Feedback already submitted. You can download your certificate.'); 
                // Use the name from the form if the user re-typed it, otherwise use the existing name from the record
                setFormData({ ...formData, name: formData.name || record.name }); 
                setSubmitted(true); 
                setIsSubmitting(false); 
                return; 
            }
            
            try { 
                const { error } = await supabase.from('feedback_submissions').update({ name: formData.name, email: formData.email, feedback: formData.feedback }).eq('registered_email', submittedEmail); 
                if (error) throw error; 
                
                try {
                    const { error: funcError } = await supabase.functions.invoke('send-feedback-email', { body: { recipientEmail: submittedEmail, recipientName: formData.name } });
                    if (funcError) throw funcError;
                } catch (funcError) {
                    console.error("‚ö†Ô∏è Failed to send email notification:", funcError.message);
                }

                setMessage('‚úÖ Thank you! A confirmation has been sent to your email.'); 
                setSubmitted(true);
            } catch (error) { setMessage(`‚ùå Submission Error: ${error.message}`);
            } finally { setIsSubmitting(false); }
        };
        
        const handleDownloadCertificate = async () => {
            setIsGenerating(true); setMessage('‚è≥ Generating certificate...');
            try {
                const [logoData, sigData] = await Promise.all([ loadImage(KILALI_LOGO_URL), loadImage(SIGNATURE_IMAGE_URL) ]);
                if (!logoData || !logoData.dataUrl) throw new Error('Kilali Logo failed to load.');
                if (!sigData || !sigData.dataUrl) throw new Error('Signature image failed to load.');

                const doc = new jsPDF({ orientation: 'l', unit: 'mm', format: 'a4' });
                const w = doc.internal.pageSize.getWidth(); const h = doc.internal.pageSize.getHeight(); const padding = 15;
                doc.setFillColor('#FFFFFF'); doc.rect(0, 0, w, h, 'F'); doc.setFillColor(PRIMARY_RED); doc.triangle(w, 0, w, h * 0.4, w * 0.6, 0, 'F'); doc.setFillColor(ACCENT_GOLD); doc.triangle(w, 0, w, h * 0.3, w * 0.7, 0, 'F');
                doc.setDrawColor(ACCENT_GOLD); doc.setLineWidth(1.5); doc.rect(padding, padding, w - 2 * padding, h - 2 * padding, 'S');
                const logoType = logoData.dataUrl.split(';')[0].split('/')[1].toUpperCase(); const targetLogoWidth = 35; const logoAspectRatio = logoData.width / logoData.height; const finalLogoHeight = targetLogoWidth / logoAspectRatio;
                doc.addImage(logoData.dataUrl, logoType, padding + 5, padding + 5, targetLogoWidth, finalLogoHeight);
                const contentStartX = w / 2; const contentStartY = 65;
                doc.setFont('helvetica', 'bold'); doc.setFontSize(24); doc.setTextColor(PRIMARY_RED); doc.text(EVENT_TITLE, contentStartX, contentStartY, { align: 'center' });
                doc.setFont('helvetica', 'bold'); doc.setFontSize(45); doc.setTextColor(TEXT_DARK); doc.text('CERTIFICATE OF PARTICIPATION', contentStartX, contentStartY + 15, { align: 'center' });
                doc.setFont('helvetica', 'normal'); doc.setFontSize(16); doc.setTextColor(TEXT_DARK); doc.text('Proudly Presented to', contentStartX, contentStartY + 35, { align: 'center' });
                doc.setFont('times', 'bolditalic'); doc.setFontSize(60); doc.setTextColor(PRIMARY_RED); const participantName = formData.name || 'Participant Name'; doc.text(participantName, contentStartX, contentStartY + 65, { align: 'center' });
                doc.setDrawColor(ACCENT_GOLD); doc.setLineWidth(1); const nameTextWidth = doc.getStringUnitWidth(participantName) * 60 / doc.internal.scaleFactor; doc.line(contentStartX - nameTextWidth/2, contentStartY + 70, contentStartX + nameTextWidth/2, contentStartY + 70);
                const detailY = contentStartY + 85;
                doc.setFont('helvetica', 'normal'); doc.setFontSize(12); doc.setTextColor(TEXT_DARK); doc.text('For successful participation in the annual conference themed:', contentStartX, detailY, { align: 'center' });
                doc.setFont('helvetica', 'bold'); doc.setFontSize(16); doc.setTextColor(PRIMARY_RED); doc.text(`‚Äú${EVENT_THEME}‚Äù`, contentStartX, detailY + 8, { align: 'center' });
                doc.setFont('helvetica', 'normal'); doc.setFontSize(12); doc.setTextColor(TEXT_DARK); doc.text(`Held on Thursday, October 23rd, at Hotel Presidential, Port Harcourt.`, contentStartX, detailY + 18, { align: 'center' });
                
                const sigBlockY = h - 28;
                const sig1X = w / 4;
                const sigType = sigData.dataUrl.split(';')[0].split('/')[1].toUpperCase();
                const sigTargetWidth = 32; 
                const sigAspectRatio = sigData.width / sigData.height;
                const finalSigHeight = sigTargetWidth / sigAspectRatio;
                doc.addImage(sigData.dataUrl, sigType, sig1X - (sigTargetWidth / 2), sigBlockY - finalSigHeight - 2, sigTargetWidth, finalSigHeight);
                doc.setDrawColor(TEXT_DARK); doc.setLineWidth(0.5); doc.line(sig1X - 30, sigBlockY, sig1X + 30, sigBlockY);
                doc.setFont('helvetica', 'bold'); doc.setFontSize(10); doc.setTextColor(TEXT_DARK); doc.text('Dr Mrs Tonye Ifie-Sekibo', sig1X, sigBlockY + 6, { align: 'center' });
                doc.setFont('helvetica', 'normal'); doc.text('Chairperson, The Kilali Tribe', sig1X, sigBlockY + 10, { align: 'center' });
                
                const sig2X = w * 3/4;
                const dateLineY = sigBlockY;
                const dateTextY = dateLineY - 2;
                doc.setFont('helvetica', 'bold'); doc.setFontSize(11); doc.text(`${new Date().toISOString().slice(0, 10)}`, sig2X, dateTextY, { align: 'center' });
                doc.setDrawColor(TEXT_DARK); doc.setLineWidth(0.5); doc.line(sig2X - 30, dateLineY, sig2X + 30, dateLineY);
                doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.text('Date of Issuance', sig2X, dateLineY + 6, { align: 'center' }); 
                
                doc.save(`${participantName.replace(/\s/g, '_')}_Certificate.pdf`);
                const { error: updateError } = await supabase.from('feedback_submissions').update({ certificate_downloaded_at: new Date().toISOString() }).eq('registered_email', formData.registeredEmail.trim().toLowerCase());
                if (updateError) throw new Error(`Failed to track download: ${updateError.message}`);
                setMessage('‚úÖ Certificate downloaded successfully!');
            } catch (error) { console.error("‚ùå Certificate generation/tracking failed:", error); setMessage(`‚ùå Error: ${error.message}`);
            } finally { setIsGenerating(false); }
        };

        const handleLogout = async () => { if (supabase) await supabase.auth.signOut(); };

        const SuccessComponent = () => (<div className="p-8 flex flex-col items-center justify-center h-full text-center"><svg className="w-16 h-16 mb-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><h1 className="text-3xl font-bold text-gray-800 mb-3">Feedback Received!</h1><p className="text-lg text-gray-600 mb-8">Thank you! Click below to get your certificate.</p><button onClick={handleDownloadCertificate} disabled={isGenerating} style={{ backgroundColor: ACCENT_GOLD }} className={`w-full max-w-sm p-4 rounded-lg font-bold text-gray-900 text-lg transition-all duration-300 shadow-md ${isGenerating ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-80 hover:-translate-y-1'}`}>{isGenerating ? 'Generating...' : 'Download Certificate'}</button></div>);

        return (
            <div className="flex flex-col min-h-screen">
                <Header user={user} isAdmin={isAdmin} onLoginClick={() => setShowLoginModal(true)} onLogoutClick={handleLogout} />
                <LoginModal show={showLoginModal} onClose={() => setShowLoginModal(false)} supabase={supabase} />
                {isAdmin ? <AdminDashboard supabase={supabase} /> : (
                    <main className="flex-grow flex items-center justify-center p-4 sm:p-6 lg:p-8">
                        <div className="bg-white rounded-2xl shadow-xl overflow-hidden max-w-6xl w-full lg:grid lg:grid-cols-2">
                            <div style={{ backgroundColor: PRIMARY_RED }} className="p-8 md:p-12 text-white flex flex-col justify-center">
                                <h2 style={{ color: ACCENT_GOLD }} className="text-lg font-semibold mb-2">{EVENT_TITLE}</h2>
                                <h1 className="text-4xl md:text-5xl font-extrabold leading-tight mb-4">Thank You for Participating!</h1>
                                <p className="text-lg opacity-90">Please fill out the short form to receive your certificate of participation.</p>
                            </div>
                            <div className="p-8 md:p-12">
                                {message && <StatusMessage msg={message} type={message.startsWith('‚ùå') ? 'error' : 'success'} />}
                                {submitted ? <SuccessComponent /> : (
                                    <form onSubmit={handleSubmit} className="space-y-5">
                                        <h2 className="text-3xl font-bold text-gray-800">Share Your Experience</h2>
                                        <input name="name" value={formData.name} onChange={handleChange} placeholder="Full Name (for Certificate)" required className="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition"/>
                                        <input name="registeredEmail" type="email" value={formData.registeredEmail} onChange={handleChange} placeholder="Your Registered Email (Required)" required className="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition"/>
                                        <input name="email" type="email" value={formData.email} onChange={handleChange} placeholder="Contact Email (Optional)" className="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition"/>
                                        <textarea name="feedback" value={formData.feedback} onChange={handleChange} placeholder="Your Feedback: What did you enjoy? What can we improve?" required className="w-full p-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-red-400 focus:outline-none transition h-32"/>
                                        <button type="submit" disabled={isSubmitting || isAuthReady && participantRecords.length === 0} style={{ backgroundColor: PRIMARY_RED }} className={`w-full p-4 rounded-lg font-bold text-white text-lg transition-all duration-300 shadow-md ${isSubmitting || isAuthReady && participantRecords.length === 0 ? 'opacity-60 cursor-not-allowed' : 'hover:opacity-80 hover:-translate-y-1'}`}>{isSubmitting ? 'Checking...' : 'Submit & Get Certificate'}</button>
                                    </form>
                                )}
                            </div>
                        </div>
                    </main>
                )}
                <footer className="w-full py-6 text-center text-sm bg-slate-100 border-t border-slate-200">
                    <div className="max-w-7xl mx-auto text-gray-500">
                        <p>Copyright &copy; {new Date().getFullYear()} <a href={KILALI_TRIBE_WEBSITE} target="_blank" rel="noopener noreferrer" className="font-semibold ml-1 hover:text-red-600 transition-colors" style={{ color: PRIMARY_RED }}>KilaliTribe</a>. All Rights Reserved.</p>
                    </div>
                </footer>
            </div>
        );
    }
</script>

<script>
    console.log("üî• Initializing Application...");
    function initializeSupabaseAndRenderApp() {
        try {
            const supabaseGlobal = window.supabase || window.Supabase;
            if (!supabaseGlobal || !supabaseGlobal.createClient) throw new Error("Supabase client function not found.");
            const SUPABASE_URL = 'https://pddykkkndrygfrwonjak.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBkZHlra2tuZHJ5Z2Zyd29uamFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDA0MzQsImV4cCI6MjA3NjE3NjQzNH0.VoQiSsAroDVTRk4CPdMOV9CJu_GRyn14Fti47O0S9dI';
            window.supabase = supabaseGlobal.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log("‚úÖ Supabase Client Initialized.");
            const checkDependencies = setInterval(() => {
                const rootElement = document.getElementById('root');
                if (rootElement && typeof ReactDOM !== 'undefined' && window.App) {
                    clearInterval(checkDependencies);
                    try { ReactDOM.createRoot(rootElement).render(React.createElement(window.App, null)); console.log("‚úÖ Application Rendered!");
                    } catch (e) { console.error("‚ùå React Rendering Failed:", e); rootElement.innerHTML = `<div style="padding:2rem;text-align:center;color:red;"><strong>Error:</strong> React rendering failed. See console.</div>`; }
                }
            }, 100);
        } catch (error) {
            console.error("‚ùå Supabase Initialization Failed:", error.message);
            document.getElementById('root').innerHTML = `<div style="padding:2rem;text-align:center;color:red;"><strong>Initialization Error:</strong> ${error.message}</div>`;
        }
    }
    if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', initializeSupabaseAndRenderApp); } else { initializeSupabaseAndRenderApp(); }
</script>
</body>
</html>